name: Terraform Version Releaser

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # jscpd:ignore-start
  list-changed-files:
    runs-on: "ubuntu-24.04"
    permissions:
      pull-requests: read
    outputs:
      changedFiles: ${{ steps.list-changed-files.outputs.result }}
    steps:
      - uses: actions/checkout@v6
      - name: List Changed Files
        id: list-changed-files
        uses: actions/github-script@v8
        with:
          script: |
            const response = await github.request(
              'GET /repos/{owner}/{repo}/pulls/{pull_number}/files',
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              }
            );
            const files = response.data.map(file => file.filename);
            console.log(files)
            return { changedFiles: files };
    # jscpd:ignore-end

  check-terraform-version:
    needs: [list-changed-files]
    if: >-
      ${{(
        contains(
          needs.list-changed-files.outputs.changedFiles,
          'Dockerfile'
        )
      )}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new Terraform version
        id: check-version
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read current version from Dockerfile
            const dockerfile = fs.readFileSync('Dockerfile', 'utf8');
            const currentVersionMatch = dockerfile.match(/ARG TERRAFORM_VERSION="([^"]+)"/);
            if (!currentVersionMatch) {
              core.setFailed('Could not find TERRAFORM_VERSION in Dockerfile');
              return;
            }
            const currentVersion = currentVersionMatch[1];
            core.info(`Current Terraform version: ${currentVersion}`);

            // Fetch latest version from HashiCorp releases API
            const response = await fetch('https://api.releases.hashicorp.com/v1/releases/terraform?limit=1');
            if (!response.ok) {
              core.setFailed(`Failed to fetch releases: ${response.statusText}`);
              return;
            }
            const releases = await response.json();
            const latestVersion = releases[0].version;
            core.info(`Latest Terraform version: ${latestVersion}`);

            // Compare versions
            const parseVersion = (v) => v.split('.').map(Number);
            const current = parseVersion(currentVersion);
            const latest = parseVersion(latestVersion);

            let isNewer = false;
            for (let i = 0; i < 3; i++) {
              if (latest[i] > current[i]) {
                isNewer = true;
                break;
              } else if (latest[i] < current[i]) {
                break;
              }
            }

            core.setOutput('current_version', currentVersion);
            core.setOutput('latest_version', latestVersion);
            core.setOutput('is_newer', isNewer.toString());

            if (isNewer) {
              core.info(`New version available: ${latestVersion}`);
            } else {
              core.info('Already on latest version');
            }

      - name: Check for existing PR
        id: check-pr
        if: steps.check-version.outputs.is_newer == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const latestVersion = '${{ steps.check-version.outputs.latest_version }}';
            const branchName = `terraform-${latestVersion}`;

            // Check if PR already exists
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branchName}`
            });

            const prExists = prs.length > 0;
            core.setOutput('pr_exists', prExists.toString());
            core.setOutput('branch_name', branchName);

            if (prExists) {
              core.info(`PR already exists for version ${latestVersion}`);
            }

      - name: Update Dockerfile and create PR
        if: steps.check-version.outputs.is_newer == 'true' && steps.check-pr.outputs.pr_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const currentVersion = '${{ steps.check-version.outputs.current_version }}';
            const latestVersion = '${{ steps.check-version.outputs.latest_version }}';
            const branchName = '${{ steps.check-pr.outputs.branch_name }}';

            // Get the default branch SHA
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            const baseSha = ref.object.sha;

            // Create new branch
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: baseSha
            });
            core.info(`Created branch: ${branchName}`);

            // Read and update Dockerfile
            const dockerfile = fs.readFileSync('Dockerfile', 'utf8');
            const updatedDockerfile = dockerfile.replace(
              /ARG TERRAFORM_VERSION="[^"]+"/,
              `ARG TERRAFORM_VERSION="${latestVersion}"`
            );

            // Get current file SHA for update
            const { data: fileData } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'Dockerfile',
              ref: branchName
            });

            // Update Dockerfile in the new branch
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'Dockerfile',
              message: `chore: bump terraform version to ${latestVersion}`,
              content: Buffer.from(updatedDockerfile).toString('base64'),
              sha: fileData.sha,
              branch: branchName
            });
            core.info('Updated Dockerfile');

            // Create pull request
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: bump terraform version to ${latestVersion}`,
              body: `## Summary\n\nThis PR updates the Terraform version from \`${currentVersion}\` to \`${latestVersion}\`.\n\n### Release Notes\n\nSee the [Terraform ${latestVersion} release notes](https://github.com/hashicorp/terraform/releases/tag/v${latestVersion}) for details.\n\n---\n\n*This PR was automatically created by the Terraform Version Updater workflow.*`,
              head: branchName,
              base: 'main'
            });

            core.info(`Created PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('pr_number', pr.number);
